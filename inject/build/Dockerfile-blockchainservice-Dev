FROM public.ecr.aws/docker/library/golang:1.17 as mod

RUN apt update && apt upgrade -y

COPY --link ./config/ /config/
COPY --link . /diadata

WORKDIR $GOPATH/src/
COPY --link ./go.mod ./

ENV GO111MODULE="on"
RUN go mod download
RUN go get github.com/karalabe/usb@v0.0.0-20210518091819-4ea20957c210

FROM public.ecr.aws/docker/library/golang:1.17 as build

# COPY --link --from=mod $GOCACHE $GOCACHE
COPY --link --from=mod $GOPATH/pkg/mod $GOPATH/pkg/mod
COPY --link . /diadata

WORKDIR $GOPATH/src/
COPY ./cmd/services/blockchainservice ./
RUN go mod edit -replace github.com/diadata-org/diadata=/diadata
RUN go mod tidy && go install
RUN go mod edit -replace github.com/diadata-org/diadata=/mnt/env-context

CMD ["blockchainservice"]